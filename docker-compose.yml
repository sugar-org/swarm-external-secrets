version: '3.8'

services:
  vault-secrets-plugin:
    image: vault-secrets-plugin:latest
    volumes:
      - /run/docker/plugins:/run/docker/plugins
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      VAULT_ADDR: "https://152.53.244.80:8200"
      VAULT_AUTH_METHOD: "approle"
      VAULT_ROLE_ID: "${VAULT_ROLE_ID}"
      VAULT_SECRET_ID: "${VAULT_SECRET_ID}"
      VAULT_MOUNT_PATH: "secret"
    privileged: true
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
    networks:
      - vault-network

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: myapp
      MYSQL_USER: appuser
    secrets:
      - source: mysql_root_password
        target: /run/secrets/mysql_root_password
      - source: mysql_password
        target: /run/secrets/mysql_password
    command: >
      bash -c "
        export MYSQL_ROOT_PASSWORD=$$(cat /run/secrets/mysql_root_password)
        export MYSQL_PASSWORD=$$(cat /run/secrets/mysql_password)
        docker-entrypoint.sh mysqld
      "
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - app-network
    deploy:
      replicas: 1

  app:
    image: myapp:latest
    environment:
      DATABASE_HOST: mysql
      DATABASE_NAME: myapp
      DATABASE_USER: appuser
    secrets:
      - source: mysql_password
        target: /run/secrets/db_password
      - source: api_key
        target: /run/secrets/api_key
    networks:
      - app-network
    depends_on:
      - mysql
    deploy:
      replicas: 3

secrets:
  mysql_root_password:
    external: true
    name: mysql_root_password
    driver: vault-secrets
    driver_opts:
      vault_path: "database/mysql"
      vault_field: "root_password"

  mysql_password:
    external: true
    name: mysql_password
    driver: vault-secrets
    driver_opts:
      vault_path: "database/mysql"
      vault_field: "user_password"

  api_key:
    external: true
    name: api_key
    driver: vault-secrets
    driver_opts:
      vault_path: "application/api"
      vault_field: "key"
      vault_reuse: "false"

volumes:
  mysql-data:
    driver: local

networks:
  vault-network:
    driver: overlay
  app-network:
    driver: overlay