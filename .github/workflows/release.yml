name: Build and Release Plugin

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  verify-build:
    name: Verify Plugin Build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build the plugin image
        run: docker build -t swarm-external-secrets:temp .
      - name: Create plugin rootfs
        run: |
          mkdir -p ./plugin/rootfs
          docker create --name temp-container swarm-external-secrets:temp
          docker export temp-container | tar -x -C ./plugin/rootfs
          docker rm temp-container
          docker rmi swarm-external-secrets:temp
      - run: cp config.json ./plugin/
      - run: docker plugin create my-test-org/swarm-external-secrets:test ./plugin
      - run: docker plugin inspect my-test-org/swarm-external-secrets:test

  semantic-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Calculate Version
        id: set-version
        run: |
          # For simplicity, use latest tag + commit count
          VERSION=$(git describe --tags --abbrev=0)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  goreleaser:
    needs: semantic-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - name: Install Syft (SBOM generator)
      - uses: anchore/sbom-action/download-syft@v0
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.semantic-release.outputs.version }}

  docker-plugin:
    needs: [goreleaser, semantic-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & Push Plugin
        env:
          PLUGIN_NAME: ghcr.io/${{ github.repository_owner }}/swarm-external-secrets
          DOCKERHUB_PLUGIN_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/swarm-external-secrets
          PLUGIN_VERSION: ${{ needs.semantic-release.outputs.version }}
        run: |
          docker build -t swarm-external-secrets:temp .
          mkdir -p ./plugin/rootfs
          docker create --name temp-container swarm-external-secrets:temp
          docker export temp-container | tar -x -C ./plugin/rootfs
          docker rm temp-container
          docker rmi swarm-external-secrets:temp
          cp config.json ./plugin/

          # GitHub Container Registry
          docker plugin create ${{ env.PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }} ./plugin
          docker plugin push ${{ env.PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }}
          docker plugin create ${{ env.PLUGIN_NAME }}:latest ./plugin
          docker plugin push ${{ env.PLUGIN_NAME }}:latest

          # Docker Hub
          docker plugin create ${{ env.DOCKERHUB_PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }} ./plugin
          docker plugin push ${{ env.DOCKERHUB_PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }}
          docker plugin create ${{ env.DOCKERHUB_PLUGIN_NAME }}:latest ./plugin
          docker plugin push ${{ env.DOCKERHUB_PLUGIN_NAME }}:latest
