name: Build and Release Plugin

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

permissions: read-all

jobs:
  # This job runs on every push and pull request to the main branch to verify the build.
  verify-build:
    name: Verify Plugin Build
    runs-on: ubuntu-latest
    # This job runs on push and PR, but not on manual dispatch.
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Build the plugin image
        run: docker build -t swarm-external-secrets:temp .

      - name: Create plugin rootfs
        run: |
          mkdir -p ./plugin/rootfs
          docker create --name temp-container swarm-external-secrets:temp
          docker export temp-container | tar -x -C ./plugin/rootfs
          docker rm temp-container
          docker rmi swarm-external-secrets:temp

      - name: Copy config.json
        run: cp config.json ./plugin/

      - name: Create the plugin for verification
        run: docker plugin create my-test-org/swarm-external-secrets:test ./plugin

      - name: Inspect the plugin to confirm it was created
        run: docker plugin inspect my-test-org/swarm-external-secrets:test

  # This job builds, pushes the plugin to Docker Hub, and creates a GitHub Release.
  # It only runs when manually triggered via the "Run workflow" button.
  release:
    name: Create and Publish Release
    runs-on: ubuntu-latest
    # This job only runs on a manual 'workflow_dispatch' trigger.
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write # Required to create a GitHub release
      packages: write # Required to push packages to a registry
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.3.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Plugin
        env:
          PLUGIN_NAME: ghcr.io/${{ github.repository_owner }}/swarm-external-secrets
          DOCKERHUB_PLUGIN_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/swarm-external-secrets
          PLUGIN_VERSION: ${{ github.event.inputs.version }}
        run: |
          # The build logic is based on your deploy.sh and build.sh scripts
          docker build -t swarm-external-secrets:temp .
          mkdir -p ./plugin/rootfs
          docker create --name temp-container swarm-external-secrets:temp
          docker export temp-container | tar -x -C ./plugin/rootfs
          docker rm temp-container
          docker rmi swarm-external-secrets:temp
          cp config.json ./plugin/

          # Create and push to GitHub Container Registry
          docker plugin create ${{ env.PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }} ./plugin
          docker plugin push ${{ env.PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }}

          docker plugin create ${{ env.PLUGIN_NAME }}:latest ./plugin
          docker plugin push ${{ env.PLUGIN_NAME }}:latest

          # Create and push to Docker Hub
          docker plugin create ${{ env.DOCKERHUB_PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }} ./plugin
          docker plugin push ${{ env.DOCKERHUB_PLUGIN_NAME }}:${{ env.PLUGIN_VERSION }}

          docker plugin create ${{ env.DOCKERHUB_PLUGIN_NAME }}:latest ./plugin
          docker plugin push ${{ env.DOCKERHUB_PLUGIN_NAME }}:latest

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.2.0
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: "Official release for version ${{ github.event.inputs.version }}."
          draft: false
          prerelease: false
