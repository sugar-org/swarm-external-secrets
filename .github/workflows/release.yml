name: Build and Release Plugin


on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:


# Permissions required for releases and containers

permissions:
  contents: write   # create GitHub releases & tags
  packages: write   # push images to GHCR

jobs:
  # JOB 1: Verify build (CI)
  
  verify-build:
    name: Verify Plugin Build
    runs-on: ubuntu-latest

    # Run only for push and PR events
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      # Checkout source code
      - name: Checkout code
        uses: actions/checkout@v4

      # Enable multi-platform Docker builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build the Docker image used by the plugin
      - name: Build the plugin image
        run: docker build -t swarm-external-secrets:temp .

      # Extract container filesystem as plugin rootfs
      - name: Create plugin rootfs
        run: |
          mkdir -p ./plugin/rootfs
          docker create --name temp-container swarm-external-secrets:temp
          docker export temp-container | tar -x -C ./plugin/rootfs
          docker rm temp-container
          docker rmi swarm-external-secrets:temp

      # Copy plugin configuration
      - name: Copy config.json
        run: cp config.json ./plugin/

      # Create a temporary plugin to verify correctness
      - name: Create plugin for verification
        run: docker plugin create my-test-org/swarm-external-secrets:test ./plugin

      # Inspect plugin to ensure it was created successfully
      - name: Inspect plugin
        run: docker plugin inspect my-test-org/swarm-external-secrets:test

  
  # JOB 2: Semantic Release (versioning)

  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest

    # Run only when manually triggered
    if: github.event_name == 'workflow_dispatch'

    # Expose whether a new release was created
    outputs:
      released: ${{ steps.semantic.outputs.new_release_published }}

    steps:
      # Full git history is required for semantic-release
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Node.js for semantic-release
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install semantic-release and required plugins
      - name: Install semantic-release
        run: |
          npm install -g semantic-release \
            @semantic-release/git \
            @semantic-release/github \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator

      # Run semantic-release
      # If no version bump is needed, no release will be created
      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

  
  # JOB 3: GoReleaser (build & publish)
  release:
    name: Build & Publish Release
    runs-on: ubuntu-latest

    # Run only if semantic-release actually created a release
    needs: semantic-release
    if: fromJSON(needs.semantic-release.outputs.released || 'false')

    steps:
      # Checkout code at the release tag
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Setup Go for building binaries
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # Enable multi-platform Docker builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Run GoReleaser
      # GoReleaser handles:
      # 1 binaries
      # 2 SBOMs
      # 3 checksums
      # 4 GitHub release
      # 5 Docker image publishing
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
